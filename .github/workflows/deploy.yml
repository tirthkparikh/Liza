name: Deploy All Projects

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  # Build and Test All Projects
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    # Install and build Main Website
    - name: Install Main Website dependencies
      run: npm ci
      
    - name: Build Main Website
      run: npm run build
      env:
        VITE_API_URL: ${{ secrets.VITE_API_URL }}
    
    # Install and build Admin Panel
    - name: Install Admin dependencies
      working-directory: ./admin
      run: npm ci
      
    - name: Build Admin Panel
      working-directory: ./admin
      run: npm run build
      env:
        VITE_API_URL: ${{ secrets.VITE_API_URL }}
    
    # Install Server dependencies
    - name: Install Server dependencies
      working-directory: ./server
      run: npm ci
      
    - name: Test Server health check
      working-directory: ./server
      run: |
        # Verify server can start (basic check)
        echo "Server dependencies installed successfully"
        
    # Upload build artifacts
    - name: Upload Main Website build
      uses: actions/upload-artifact@v4
      with:
        name: main-website-build
        path: dist/
        
    - name: Upload Admin build
      uses: actions/upload-artifact@v4
      with:
        name: admin-build
        path: admin/dist/

  # Deploy to Vercel (Main Website)
  deploy-main-vercel:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Deploy Main Website to Vercel
      uses: amondnet/vercel-action@v25
      with:
        vercel-token: ${{ secrets.VERCEL_TOKEN }}
        vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
        vercel-project-id: ${{ secrets.VERCEL_MAIN_PROJECT_ID }}
        working-directory: ./
        vercel-args: '--prod'
      env:
        VITE_API_URL: ${{ secrets.VITE_API_URL }}

  # Deploy to Vercel (Admin Panel)
  deploy-admin-vercel:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Deploy Admin to Vercel
      uses: amondnet/vercel-action@v25
      with:
        vercel-token: ${{ secrets.VERCEL_TOKEN }}
        vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
        vercel-project-id: ${{ secrets.VERCEL_ADMIN_PROJECT_ID }}
        working-directory: ./admin
        vercel-args: '--prod'
      env:
        VITE_API_URL: ${{ secrets.VITE_API_URL }}

  # Deploy to Railway (Backend Server)
  deploy-server-railway:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install Railway CLI
      run: npm install -g @railway/cli
      
    - name: Deploy to Railway
      working-directory: ./server
      run: railway up --service liza-backend
      env:
        RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

  # Alternative: Deploy to Render (Backend)
  deploy-server-render:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && false  # Set to true to enable
    
    steps:
    - name: Deploy to Render
      uses: johnbeynon/render-deploy-action@v0.0.8
      with:
        service-id: ${{ secrets.RENDER_SERVICE_ID }}
        api-key: ${{ secrets.RENDER_API_KEY }}

  # Notify on Success
  notify-success:
    needs: [deploy-main-vercel, deploy-admin-vercel, deploy-server-railway]
    runs-on: ubuntu-latest
    if: success()
    
    steps:
    - name: Deployment Success
      run: |
        echo "‚úÖ All deployments successful!"
        echo "üåê Main Website: ${{ secrets.MAIN_WEBSITE_URL }}"
        echo "üéõÔ∏è Admin Panel: ${{ secrets.ADMIN_URL }}"
        echo "üöÄ Backend Server: ${{ secrets.BACKEND_URL }}"

  # Notify on Failure
  notify-failure:
    needs: [deploy-main-vercel, deploy-admin-vercel, deploy-server-railway]
    runs-on: ubuntu-latest
    if: failure()
    
    steps:
    - name: Deployment Failed
      run: |
        echo "‚ùå Deployment failed!"
        echo "Please check the logs above for details."